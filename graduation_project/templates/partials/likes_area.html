<!-- Include Font Awesome -->
 {% load static %}
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
<link rel="stylesheet" href="{% static 'css/project/projects.css' %}">

<div class="like-container" id="likesarea">
    <span class="like-count">{{ object.likes.count }} 👁️</span>
    
    {% if request.user.is_authenticated %}
        <button hx-post="{% url 'project:like_post' object.id %}" 
                class="like-btn {% if request.user in post.likes.all %}liked{% else %}unliked{% endif %}"
                hx-target="#likesarea" 
                hx-swap="outerHTML"
                onclick="toggleLike(this)">
            {% if request.user in object.likes.all %}
                <i class="fas fa-heart"></i>
                <span>معجب</span>
            {% else %}
                <i class="far fa-thumbs-up"></i>
                <span>أعجبني</span>
            {% endif %}
        </button>
    {% else %}
        <a href="{% url 'login' %}?next={{ request.path }}" class="like-btn unliked">
            <i class="far fa-thumbs-up"></i>
            <span>سجل دخول للإعجاب</span>
        </a>
    {% endif %}
    
    <div class="likers-list">
        <p>المعجبون</p>
        <ul>
            {% for user in object.likes.all %}
                <li>{{ user.username }}</li>
            {% empty %}
                <li>لا يوجد معجبين بعد</li>
            {% endfor %}
        </ul>
    </div>
</div>

<script>
    // Toggle like state immediately for better UX
    function toggleLike(btn) {
        if (btn.classList.contains('liked')) {
            btn.classList.remove('liked');
            btn.classList.add('unliked');
            btn.innerHTML = '<i class="far fa-thumbs-up"></i><span>أعجبني</span>';
        } else {
            btn.classList.remove('unliked');
            btn.classList.add('liked');
            btn.innerHTML = '<i class="fas fa-heart"></i><span>معجب</span>';
        }
    }

    // Show/hide likers list
    document.querySelector(".like-count").addEventListener("click", function(e) {
        e.stopPropagation();
        const list = document.querySelector(".likers-list");
        list.style.display = list.style.display === "block" ? "none" : "block";
    });

    // Close likers list when clicking outside
    document.addEventListener("click", function() {
        document.querySelector(".likers-list").style.display = "none";
    });

    // Prevent closing when clicking inside the list
    document.querySelector(".likers-list").addEventListener("click", function(e) {
        e.stopPropagation();
    });

    // Handle HTMX after swap to maintain state
    document.addEventListener("htmx:afterSwap", function(evt) {
        if (evt.detail.target.id === "likesarea") {
            // Update the like count display
            const response = JSON.parse(evt.detail.xhr.responseText);
            document.querySelector(".like-count").textContent = `${response.count} 👁️`;
            
            // Update button state based on response
            const likeBtn = document.querySelector(".like-btn");
            if (response.status === 'liked') {
                likeBtn.classList.remove('unliked');
                likeBtn.classList.add('liked');
                likeBtn.innerHTML = '<i class="fas fa-heart"></i><span>معجب</span>';
            } else {
                likeBtn.classList.remove('liked');
                likeBtn.classList.add('unliked');
                likeBtn.innerHTML = '<i class="far fa-thumbs-up"></i><span>أعجبني</span>';
            }
        }
    });
</script>